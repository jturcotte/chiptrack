// Copyright Â© 2021 Jocelyn Turcotte <turcotte.j@gmail.com>
// SPDX-License-Identifier: MIT

export struct SongPatternData := {
    number: int,
    active: bool,
}
export struct PatternData := {
    empty: bool,
    active: bool,
}
export struct PatternInstrumentData := {
    id: string,
    steps_empty: [bool],
}
export struct StepData := {
    press: bool,
    release: bool,
    active: bool,
    note_name: string,
}
export struct InstrumentData := {
    id: string,
    selected: bool,
    active: bool,
    muted: bool,
}
export struct NoteData := {
    note_number: int,
    key_pos: int,
    is_black: bool,
    active: bool,
}
export struct ChannelTraceNote := {
    channel: int,
    start_tick: int,
    num_ticks: int,
    octave: int,
    key_pos: int,
    cent_adj: float,
    is_black: bool,
    volume: float,
}
export struct ChannelActiveNote := {
    trace: ChannelTraceNote,
    note_name: string,
}
export struct Settings := {
    sync_enabled: bool,
}
export struct SongSettings := {
    frames_per_step: int,
}

export global GlobalEngine := {
    property<[SongPatternData]> sequencer_song_patterns: [
        {number: 0},
        {number: 1},
        {number: 0},
        {number: 1},
        {number: 0, active: true},
        {number: 1},
        {number: 2},
        {number: 3}];
    property<[PatternData]> sequencer_patterns: [
        {empty: true, active: true},
        {empty: true}, {empty: true}, {empty: true},
        {empty: true}, {empty: true}, {empty: true}, {empty: true},
        {empty: true}, {empty: true}, {empty: true}, {empty: true},
        {empty: true}, {empty: true}, {empty: true}, {empty: true},
        ];
    property<[PatternInstrumentData]> sequencer_pattern_instruments: [
        {id: "S1", steps_empty: [true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false] },
        {id: "T2", steps_empty: [true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false] },
        {id: "W1", steps_empty: [true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true] },
        {id: "N2", steps_empty: [true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false] },
        {id: "N4", steps_empty: [true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false] },
    ];
    property<[StepData]> sequencer_steps: [
        {press: true, note_name: "C-4"},
        {press: false}, {press: false}, {press: false},
        {press: true, release: true, note_name: "C-4", active: true},
        {press: false}, {press: false}, {press: false},
        {press: true, note_name: "C-4"},
        {press: false}, {press: false}, {press: false},
        {press: false, release: true},
        {press: false}, {press: false}, {press: false}];
    property<[InstrumentData]> instruments: [
        {active: false}, {active: false}, {active: false}, {active: false},
        {active: false}, {active: false}, {active: false}, {active: false},
        {active: false}, {active: false}, {active: false}, {active: false},
        {active: false}, {active: false}, {active: false}, {active: false},
        ];

    property<int> current_instrument: 0;
    property<int> synth_tick: 0;
    callback phase_visualization_tick(float) -> float;

    property<[ChannelTraceNote]> synth_trace_notes: [
        { channel: 0, start_tick: 123, num_ticks: 1, octave: 3, key_pos: 0, is_black: false, volume: 1.0, },
        { channel: 0, start_tick: 123, num_ticks: 1, octave: 3, key_pos: 3, is_black: true, volume: 1.0, },
        { channel: 0, start_tick: 122, num_ticks: 1, octave: 3, key_pos: 0, is_black: false, volume: 1.0, },
        { channel: 0, start_tick: 121, num_ticks: 1, octave: 3, key_pos: 0, is_black: false, volume: 1.0, },
    ];
    property<[ChannelActiveNote]> synth_active_notes: [
        { trace: { channel: 0, start_tick: 123, num_ticks: 1, octave: 3, key_pos: 0, is_black: false, volume: 1.0, }, note_name: "C", },
        { trace: { channel: 0, start_tick: 123, num_ticks: 1, octave: 3, key_pos: 3, is_black: true, volume: 1.0, }, note_name: "F#", },
    ];

    callback note_key_pressed(int);
    callback note_pressed(int);
    callback note_released(int);
    callback select_instrument(int);
    callback cycle_pattern_instrument(bool);
    callback toggle_mute_instrument(int);
    callback pattern_clicked(int);
    callback toggle_step(int);
    callback toggle_step_release(int);
    callback manually_advance_step(bool);
    callback play_clicked(bool);
    callback record_clicked(bool);
    callback append_song_pattern(int);
    callback remove_last_song_pattern();
    callback clear_song_patterns();
    callback save_project();
    callback export_project_as_gba_sav();
    callback mute_instruments();
}

export global GlobalSettings := {
    property<Settings> settings: {
        sync_enabled: false,
    };
    property<SongSettings> song_settings: {
        frames_per_step: 7,
    };
    callback settings_changed(Settings);
    callback song_settings_changed(SongSettings);
}

export global GlobalUtils := {
    callback get_midi_note_name(int) -> string;
    callback mod(float, float) -> float;
}
